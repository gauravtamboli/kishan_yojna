<ion-header shadow="none">
  <ion-toolbar class="govt-toolbar" color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/officers-dashboard-ro" icon="chevron-back-outline"></ion-back-button>
    </ion-buttons>
    <ion-title class="govt-title">
      रोपित पौधों की संख्या दर्ज करें
    </ion-title>
  </ion-toolbar>
</ion-header>


<ion-content class="content-wrapper">
  <ion-loading [isOpen]="isLoading" [message]="loadingMessage" [backdropDismiss]="false"></ion-loading>

  <div class="page-container">
    <!-- Search Section -->
    <ion-card class="search-card">
      <ion-card-content>
        <ion-row class="search-row">
          <ion-col size="12" size-md="4" class="search-label-col">
            <ion-input [(ngModel)]="searchText" fill="outline" class="search-input"
              placeholder="आवेदन नंबर, हितग्राही नाम, पिता का नाम, गाँव या ग्राम पंचायत से खोजें"
              (ionInput)="onSearch()" (keyup.enter)="onSearchEnter()">
              <ion-icon name="search-outline" slot="start"></ion-icon>
            </ion-input>
          </ion-col>
        </ion-row>
      </ion-card-content>
    </ion-card>

    <!-- Table Section -->
    <div *ngIf="filteredData.length > 0" class="table-container">
      <div class="table-responsive shadow-sm rounded-4">
        <p-table [value]="filteredData" [paginator]="false" [responsiveLayout]="'scroll'"
          class="bootstrap-table p-datatable-striped p-datatable-hoverable-rows custom-table" styleClass="ropit-table">

          <!-- Header -->
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 50px;">#</th>
              <th>आवेदन नंबर</th>
              <th>हितग्राही का नाम</th>
              <th>पिता का नाम</th>
              <th>गाँव/शहर</th>
              <th>ग्राम पंचायत/नगर</th>
              <th>पता</th>
              <th>रोपित पौधों की संख्या दर्ज करे</th>
              <th class="text-center" style="min-width: 120px;">
                कुल रोपित पौधों की संख्या
              </th>
            </tr>
          </ng-template>

          <!-- Body -->
          <ng-template pTemplate="body" let-item let-i="rowIndex">
            <tr>
              <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>

              <td>
                <strong class="app-number-cell">
                  {{ item.ApplicationNumber }}
                </strong>
              </td>

              <td>{{ item.HitgrahiName || 'N/A' }}</td>
              <td>{{ item.FatherName || 'N/A' }}</td>
              <td>{{ item.VillageCityName || 'N/A' }}</td>
              <td>{{ item.GramPanchayatNagar || 'N/A' }}</td>

              <td class="address-cell">
                {{ item.Address || 'N/A' }}
              </td>

              <!-- PLANTS COLUMN -->
              <td style="width: 260px;">
                <div *ngIf="item.Plants?.length > 0; else noPlants">

                  <div *ngFor="let plant of item.Plants; let plantIndex = index" class="plant-line">

                    <!-- LEFT: Plant name + details -->
                    <div class="plant-left">
                      <ion-icon name="leaf-outline" class="plant-icon-small"></ion-icon>
                      <strong class="plant-name">{{ plant.PlantName }}</strong>
                    </div>

                    <!-- MIDDLE: Input -->
                    <div class="plant-middle">
                      <input type="number" class="plant-input-native" [max]="plant.TotalPit" min="0"
                        placeholder="संख्या" #plantQty />
                    </div>

                    <!-- RIGHT: Button -->
                    <div class="plant-right">
                      <button type="button" class="govt-add-btn"
                        (click)="addPlantRow(item.ApplicationNumber, plant.PlantId, plantQty.value, plant.TotalPit)">
                        Add
                      </button>
                    </div>

                  </div>
                </div>

                <ng-template #noPlants>
                  <div style="text-align: center;">
                    <small class="text-muted">कोई जानकारी नहीं</small>
                  </div>
                </ng-template>

              </td>

              <td style="width: 400px;">
                <div *ngIf="item.Plants?.length > 0; else noPlants">

                  <div *ngFor="let plant of item.Plants; let plantIndex = index" class="plant-line">

                    <!-- LEFT: Plant name + details -->
                    <div class="plant-left  ">
                      <ion-icon name="leaf-outline" class="plant-icon-small"></ion-icon>
                      <strong class="plant-name">{{ plant.PlantName }}</strong>
                      <span class="plant-details">
                        (क्षेत्र: {{ plant.TotalArea }} हे., पौधे: {{ plant.TotalTree }}, गड्ढे: {{ plant.TotalPit || 0
                        }})
                      </span>
                    </div>
                    <div class="action-buttons-container">
                      <strong> कुल रोपित पौधे :- {{plant.TotalRopit}}</strong>
                    </div>
                  </div>
                </div>
              </td>

            </tr>
          </ng-template>


        </p-table>
      </div>
    </div>

    <!-- No Records Message -->
    <ion-card *ngIf="filteredData.length === 0 && !isLoading" class="no-records-card">
      <ion-card-content>
        <div class="no-records-content">
          <ion-icon name="document-text-outline" class="no-records-icon"></ion-icon>
          <h3>कोई आवेदन प्राप्त नहीं</h3>
          <p>कृपया खोज मानदंड बदलकर पुनः प्रयास करें</p>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Pagination -->
    <ion-card *ngIf="totalPages > 1" class="pagination-card">
      <ion-card-content>
        <div class="pagination-container">
          <ion-row class="align-items-center justify-content-center">
            <ion-col size="auto">
              <ion-button [disabled]="currentPage === 1" (click)="goToPreviousPage()" fill="outline" size="small"
                class="pagination-btn">
                <ion-icon name="chevron-back-outline" slot="start"></ion-icon>
                पिछला
              </ion-button>
            </ion-col>

            <ion-col size="auto">
              <div class="page-numbers">
                <ion-button *ngFor="let page of getPageNumbers()" [color]="page === currentPage ? 'primary' : 'medium'"
                  [fill]="page === currentPage ? 'solid' : 'outline'" size="small" (click)="goToPage(page)"
                  class="page-btn">
                  {{ page }}
                </ion-button>
              </div>
            </ion-col>

            <ion-col size="auto">
              <div class="pagination-container">
                <ion-button [disabled]="currentPage === totalPages" (click)="goToNextPage()" fill="outline" size="small"
                  class="pagination-btn">
                  अगला
                  <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
                </ion-button>
              </div>
            </ion-col>

            <ion-col size="auto" class="pagination-info">
              <div class="pagination-text">
                <small>पृष्ठ <strong>{{ currentPage }}</strong> / <strong>{{ totalPages }}</strong></small>
                <small class="total-records">(कुल {{ totalRecords }} रिकॉर्ड)</small>
              </div>
            </ion-col>
          </ion-row>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Status/Action Modal -->
  <ion-modal [isOpen]="isStatusModalOpen" (didDismiss)="closeStatusModal()" [backdropDismiss]="false"
    class="confirmation-modal">
    <ng-template>
      <ion-content scroll-y="false">
        <div class="confirm-content">
          <div class="confirm-icon-wrapper" [class.success]="statusType === 'success'"
            [class.error]="statusType === 'error'" [class.question]="statusType === 'question'">
            <ion-icon [name]="statusType === 'success' ? 'checkmark-circle-outline' : 
                         (statusType === 'error' ? 'alert-circle-outline' : 'help-circle-outline')"
              class="confirm-icon"></ion-icon>
          </div>

          <h3 class="confirm-title" [class.success-text]="statusType === 'success'"
            [class.error-text]="statusType === 'error'">
            {{ statusType === 'success' ? 'सफल' : (statusType === 'error' ? 'त्रुटि' : 'पुष्टि करें') }}
          </h3>

          <p class="confirm-message">
            {{ statusMessage }}
          </p>

          <div class="confirm-actions">
            <!-- Confirm/OK Button -->
            <ion-button *ngIf="statusType === 'question'" expand="block" color="success" (click)="confirmAction()">
              हाँ, दर्ज करें
            </ion-button>

            <!-- Regular OK Button for success/error -->
            <ion-button *ngIf="statusType !== 'question'" expand="block"
              [color]="statusType === 'success' ? 'success' : 'danger'" (click)="closeStatusModal()">
              ठीक है
            </ion-button>

            <!-- Cancel Button for Question -->
            <ion-button *ngIf="statusType === 'question'" expand="block" fill="clear" color="medium"
              (click)="closeStatusModal()">
              नहीं
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>